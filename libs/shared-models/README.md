# Shared Models Package

This package contains the shared database models, schemas, and database configuration used across all Vexa services.

## Contents

- **Models** (`models.py`): SQLAlchemy ORM models for all database entities
- **Schemas** (`schemas.py`): Pydantic schemas for API validation and serialization
- **Database** (`database.py`): Database connection and configuration utilities
- **Migrations** (`alembic/`): Alembic database migrations

## Database Models

### Core Models
- `User`: Application users
- `APIToken`: API authentication tokens
- `Meeting`: Meeting records with platform information
- `MeetingSession`: Session tracking for reconnections
- `Transcription`: Transcript segments
- `SpeakerEvent`: Speaker activity events (Phase 2)

### Enums
- `Platform`: Supported meeting platforms (Google Meet, Zoom, Teams)
- `SpeakerEventType`: Speaker event types (SPEAKER_START, SPEAKER_END)

## Database Migrations with Alembic

### Setup
Alembic is configured to manage database schema changes for the Vexa project.

### Configuration Files
- `alembic.ini`: Alembic configuration
- `alembic/env.py`: Migration environment setup
- `alembic/versions/`: Migration files

### Running Migrations

#### Inside Docker Container (Recommended)
Since the database runs in Docker, all alembic commands should be executed inside a container with database access:

```bash
# Create a new migration
docker-compose exec transcription-collector bash -c "cd /app && alembic revision --autogenerate -m 'Description of changes'"

# Apply migrations
docker-compose exec transcription-collector bash -c "cd /app && alembic upgrade head"

# Check current migration status
docker-compose exec transcription-collector bash -c "cd /app && alembic current"

# Show migration history
docker-compose exec transcription-collector bash -c "cd /app && alembic history"

# Downgrade to previous migration
docker-compose exec transcription-collector bash -c "cd /app && alembic downgrade -1"
```

#### Copy Migration Files
After creating migrations in the container, copy them back to the host for version control:

```bash
# Copy new migration file back to host
docker cp vexa_dev-transcription-collector-1:/app/alembic/versions/NEW_MIGRATION_FILE.py libs/shared-models/alembic/versions/
```

### Migration Workflow

1. **Modify Models**: Update the SQLAlchemy models in `models.py`
2. **Rebuild Containers**: Run `make all TARGET=gpu` to rebuild with updated models
3. **Generate Migration**: Create autogenerated migration in container
4. **Review Migration**: Check the generated migration file for accuracy
5. **Apply Migration**: Run `alembic upgrade head` in container
6. **Copy Files**: Copy migration files back to host for version control

### Current Schema State

The database schema includes:
- ✅ Users and API tokens
- ✅ Meetings and sessions
- ✅ Transcription segments
- ✅ Speaker events (Phase 2)

Migration `7fa95b5a0eb7`: Initial migration capturing existing schema with speaker_events table.

## Environment Variables

The database connection is configured via environment variables:
- `DB_HOST`: Database host (default: "postgres")
- `DB_PORT`: Database port (default: "5432") 
- `DB_NAME`: Database name (default: "vexa")
- `DB_USER`: Database user (default: "postgres")
- `DB_PASSWORD`: Database password (default: "postgres")

## Development

### Adding New Models

1. Define the SQLAlchemy model in `models.py`
2. Add corresponding Pydantic schemas in `schemas.py`
3. Create and apply migration using the workflow above
4. Update this README with new model information

### Testing Database Changes

```bash
# Check table structure
docker-compose exec postgres psql -U postgres -d vexa -c "\\d table_name"

# List all tables
docker-compose exec postgres psql -U postgres -d vexa -c "\\dt"

# Run custom SQL queries
docker-compose exec postgres psql -U postgres -d vexa -c "SELECT * FROM speaker_events LIMIT 5;"
```

## Phase 2 Integration

The shared-models package is ready for Phase 2 speaker timeline integration with:
- `SpeakerEvent` model for tracking speaker activity
- Enhanced schemas for speaker timeline responses
- Proper database indexes for efficient querying
- Alembic migrations for schema management 