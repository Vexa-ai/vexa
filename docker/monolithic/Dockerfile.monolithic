# =============================================================================
# Vexa Monolithic - All-in-One Docker Image
# =============================================================================
#
# This Dockerfile creates a single container with all Vexa services:
# - API Gateway (port 8056)
# - Admin API (port 8057)
# - Bot Manager (with process orchestrator)
# - Transcription Collector
# - WhisperLive (CPU-based transcription)
# - Vexa Bot (Node.js/Playwright)
#
# Designed for simple deployments on platforms like EasyPanel, Dokploy, etc.
# where Docker socket access is not available.
#
# Build:
#   docker build -f Dockerfile.monolithic -t vexa-monolithic .
#
# Run:
#   docker run -d \
#     -p 8056:8056 \
#     -e DATABASE_URL="postgresql://user:pass@host:5432/vexa" \
#     -e ADMIN_API_TOKEN=your-secret-token \
#     -e REMOTE_TRANSCRIBER_URL="http://localhost:8083/v1/audio/transcriptions" \
#     -e REMOTE_TRANSCRIBER_API_KEY=your-api-key \
#     vexa-monolithic
#
# =============================================================================

# -----------------------------------------------------------------------------
# Base Image: Playwright with browsers pre-installed
# -----------------------------------------------------------------------------
FROM mcr.microsoft.com/playwright:v1.56.0-jammy AS base

# Avoid prompts during package installation
ENV DEBIAN_FRONTEND=noninteractive

# Install system dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \
    # Python 3.10+
    python3 \
    python3-pip \
    python3-venv \
    python3-dev \
    # Build tools (needed for some Python packages)
    build-essential \
    gcc \
    g++ \
    # Audio/Video processing
    xvfb \
    pulseaudio \
    ffmpeg \
    libsndfile1 \
    # Process management
    supervisor \
    # Database clients (for health checks and migrations)
    postgresql-client \
    redis-tools \
    # Redis server (for monolithic deployment)
    redis-server \
    # Utilities
    curl \
    wget \
    git \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# Create directory structure
WORKDIR /app
RUN mkdir -p \
    /app/api-gateway \
    /app/admin-api \
    /app/bot-manager \
    /app/transcription-collector \
    /app/whisperlive \
    /app/vexa-bot \
    /app/shared-models \
    /app/alembic \
    /var/log/supervisor \
    /var/log/vexa-bots \
    /var/lib/redis \
    /var/run/redis

# -----------------------------------------------------------------------------
# Python Dependencies Stage
# -----------------------------------------------------------------------------

# Copy requirements files first
COPY docker/monolithic/requirements-monolithic.txt /tmp/requirements-monolithic.txt
COPY services/WhisperLive/requirements/server.txt /tmp/requirements-whisperlive.txt

# Install consolidated Python dependencies for all services
RUN pip3 install --no-cache-dir -r /tmp/requirements-monolithic.txt

# WhisperLive dependencies (CPU version)
# Note: openai-whisper and onnxruntime GPU versions are excluded
RUN sed -i '/openai-whisper/d' /tmp/requirements-whisperlive.txt || true \
    && sed -i '/onnxruntime==/d' /tmp/requirements-whisperlive.txt || true \
    && pip3 install --no-cache-dir -r /tmp/requirements-whisperlive.txt \
    && pip3 install --no-cache-dir onnxruntime \
    && pip3 install --no-cache-dir torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cpu \
    && pip3 install --no-cache-dir 'faster-whisper[cpu]'

# Clean up requirements files
RUN rm -f /tmp/requirements-*.txt

# Copy shared library
COPY libs/shared-models /app/shared-models

# Add shared_models to Python path (more reliable than pip install)
ENV PYTHONPATH="/app/shared-models:${PYTHONPATH}"

# Verify shared_models is importable
RUN python3 -c "import shared_models; print(f'shared_models found at: {shared_models.__file__}')" \
    && python3 -c "from shared_models.models import User, Meeting; print('Models imported successfully')"

# -----------------------------------------------------------------------------
# Application Code
# -----------------------------------------------------------------------------

# API Gateway
COPY services/api-gateway/ /app/api-gateway/

# Admin API
COPY services/admin-api/ /app/admin-api/

# Bot Manager (including the new process orchestrator)
COPY services/bot-manager/app/ /app/bot-manager/app/

# Transcription Collector
COPY services/transcription-collector/ /app/transcription-collector/

# WhisperLive
COPY services/WhisperLive/ /app/whisperlive/

# Alembic migrations
COPY alembic.ini /app/alembic.ini
COPY libs/shared-models/alembic/ /app/alembic/

# -----------------------------------------------------------------------------
# Node.js Bot Build
# -----------------------------------------------------------------------------

# Copy vexa-bot source
COPY services/vexa-bot/core/ /app/vexa-bot/

# Build the bot
WORKDIR /app/vexa-bot
RUN npm ci --omit=dev 2>/dev/null || npm install \
    && npm run build

# Install additional browsers for Teams support
RUN npx playwright install msedge --with-deps || true

# Ensure browser-utils is built
RUN node build-browser-utils.js || true

# Return to app directory
WORKDIR /app

# -----------------------------------------------------------------------------
# Configuration Files
# -----------------------------------------------------------------------------

# Supervisor configuration
COPY docker/monolithic/supervisord.conf /etc/supervisor/conf.d/vexa.conf

# Entrypoint script
COPY docker/monolithic/entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

# -----------------------------------------------------------------------------
# Environment Variables (defaults)
# -----------------------------------------------------------------------------

# Orchestrator configuration
ENV ORCHESTRATOR=process \
    BOT_SCRIPT_PATH=/app/vexa-bot/dist/docker.js \
    BOT_WORKING_DIR=/app/vexa-bot \
    BOT_CALLBACK_BASE_URL=http://localhost:8080

# WhisperLive configuration
ENV WHISPER_LIVE_URL=ws://localhost:9090 \
    DEVICE_TYPE=remote \
    WHISPER_BACKEND=remote \
    WHISPER_MODEL_SIZE=tiny \
    CONSUL_ENABLE=false

# Display for headless browsers
ENV DISPLAY=:99

# Logging
ENV LOG_LEVEL=info \
    PYTHONUNBUFFERED=1

# Database defaults (should be overridden)
# Note: DB_PASSWORD must be provided at runtime via -e flag
ENV DB_HOST=localhost \
    DB_PORT=5432 \
    DB_NAME=vexa \
    DB_USER=postgres

# Redis defaults (for internal Redis server)
ENV REDIS_HOST=localhost \
    REDIS_PORT=6379 \
    REDIS_PASSWORD=""

# Remote transcription defaults
ENV REMOTE_TRANSCRIBER_MODEL="whisper-1" \
    REMOTE_TRANSCRIBER_TEMPERATURE="0"

# -----------------------------------------------------------------------------
# Ports
# -----------------------------------------------------------------------------

# API Gateway (main entry point)
EXPOSE 8056

# Admin API
EXPOSE 8057

# -----------------------------------------------------------------------------
# Health Check
# -----------------------------------------------------------------------------

HEALTHCHECK --interval=30s --timeout=10s --start-period=90s --retries=3 \
    CMD curl -sf http://localhost:8056/docs > /dev/null || exit 1

# -----------------------------------------------------------------------------
# Entrypoint
# -----------------------------------------------------------------------------

ENTRYPOINT ["/entrypoint.sh"]
CMD ["supervisord", "-n", "-c", "/etc/supervisor/conf.d/vexa.conf"]
